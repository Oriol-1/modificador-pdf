# GitHub Actions - Compilación automática para Windows, macOS y Linux
# Cada vez que hagas push o release, se generan los instaladores

name: Build Installers

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite ejecutar manualmente

# Permisos necesarios para crear releases
permissions:
  contents: write

jobs:
  # ==================== BUILD WINDOWS ====================
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install Pillow
    
    - name: Generar icono
      run: python installer/create_icon.py
    
    - name: Compilar con PyInstaller
      run: pyinstaller --clean --noconfirm ModificadorPDF.spec
    
    - name: Crear ZIP portátil
      run: |
        Compress-Archive -Path "dist\ModificadorPDF\*" -DestinationPath "dist\ModificadorPDF_Windows_Portable.zip"
    
    - name: Instalar Inno Setup
      run: |
        choco install innosetup -y
    
    - name: Crear carpeta para instalador
      run: |
        New-Item -ItemType Directory -Force -Path "dist\installer"
      shell: powershell
    
    - name: Crear instalador
      run: |
        echo "=== Verificando archivos necesarios ==="
        Test-Path "dist\ModificadorPDF" 
        Test-Path "installer\inno_setup.iss"
        Test-Path "installer\app_icon.ico"
        echo "=== Ejecutando Inno Setup ==="
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /O"dist" "installer\inno_setup.iss"
        echo "=== Verificando resultado ==="
        Get-ChildItem -Path dist -Filter "*.exe" | Select-Object FullName, Length
      shell: powershell
    
    - name: Listar archivos generados
      run: |
        echo "=== Contenido de dist ==="
        Get-ChildItem -Path dist -Recurse | Select-Object FullName
        echo "=== Buscando .exe ==="
        Get-ChildItem -Path . -Recurse -Filter "*.exe" | Where-Object { $_.Name -like "*Setup*" } | Select-Object FullName
      shell: powershell
    
    - name: Subir artefactos Windows
      uses: actions/upload-artifact@v4
      with:
        name: Windows-Installers
        path: |
          dist/installer/*.exe
          dist/*.exe
          dist/*.zip
        retention-days: 30

  # ==================== BUILD macOS ====================
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install Pillow
    
    - name: Generar icono PNG
      run: python installer/create_icon.py
    
    - name: Crear icono ICNS para macOS
      run: |
        mkdir -p installer/icon.iconset
        sips -z 16 16     installer/app_icon_mac.png --out installer/icon.iconset/icon_16x16.png
        sips -z 32 32     installer/app_icon_mac.png --out installer/icon.iconset/icon_16x16@2x.png
        sips -z 32 32     installer/app_icon_mac.png --out installer/icon.iconset/icon_32x32.png
        sips -z 64 64     installer/app_icon_mac.png --out installer/icon.iconset/icon_32x32@2x.png
        sips -z 128 128   installer/app_icon_mac.png --out installer/icon.iconset/icon_128x128.png
        sips -z 256 256   installer/app_icon_mac.png --out installer/icon.iconset/icon_128x128@2x.png
        sips -z 256 256   installer/app_icon_mac.png --out installer/icon.iconset/icon_256x256.png
        sips -z 512 512   installer/app_icon_mac.png --out installer/icon.iconset/icon_256x256@2x.png
        sips -z 512 512   installer/app_icon_mac.png --out installer/icon.iconset/icon_512x512.png
        sips -z 1024 1024 installer/app_icon_mac.png --out installer/icon.iconset/icon_512x512@2x.png
        iconutil -c icns installer/icon.iconset -o installer/app_icon.icns
    
    - name: Compilar con PyInstaller
      run: pyinstaller --clean --noconfirm ModificadorPDF.spec
    
    - name: Crear ZIP portátil macOS
      run: |
        cd dist
        if [ -d "Modificador de PDF.app" ]; then
          zip -r ModificadorPDF_macOS_Portable.zip "Modificador de PDF.app"
        elif [ -d "ModificadorPDF" ]; then
          zip -r ModificadorPDF_macOS_Portable.zip ModificadorPDF
        fi
    
    - name: Crear DMG
      run: |
        # Limpiar directorios anteriores
        rm -rf dist/dmg_temp dist/*.dmg
        
        # Crear estructura DMG
        mkdir -p dist/dmg_temp
        
        # Copiar app
        if [ -d "dist/Modificador de PDF.app" ]; then
          cp -R "dist/Modificador de PDF.app" dist/dmg_temp/
        elif [ -d "dist/ModificadorPDF.app" ]; then
          cp -R "dist/ModificadorPDF.app" dist/dmg_temp/
        else
          echo "Error: No se encontró la aplicación compilada"
          exit 1
        fi
        
        # Crear enlace a Applications
        ln -s /Applications dist/dmg_temp/Applications
        
        # Crear DMG con reintentos
        for i in {1..3}; do
          echo "Intento $i de crear DMG..."
          hdiutil create -volname "Modificador de PDF" \
                         -srcfolder dist/dmg_temp \
                         -ov -format UDZO \
                         "dist/ModificadorPDF_macOS.dmg" && break || sleep 2
        done
        
        # Limpiar directorio temporal
        rm -rf dist/dmg_temp
    
    - name: Subir artefactos macOS
      uses: actions/upload-artifact@v4
      with:
        name: macOS-Installer
        path: |
          dist/ModificadorPDF_macOS.dmg
          dist/ModificadorPDF_macOS_Portable.zip
        retention-days: 30

  # ==================== BUILD LINUX ====================
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar dependencias del sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-shape0 \
          libegl1 \
          libgl1-mesa-glx \
          libfuse2 \
          fuse
    
    - name: Instalar dependencias Python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install Pillow
    
    - name: Generar icono
      run: python installer/create_icon.py
    
    - name: Compilar con PyInstaller
      run: pyinstaller --clean --noconfirm ModificadorPDF.spec
    
    - name: Crear versión portable (tar.gz)
      run: |
        cd dist
        tar -czvf ModificadorPDF_Linux_Portable.tar.gz ModificadorPDF/
    
    - name: Crear paquete DEB
      run: |
        # Crear estructura de directorios para el .deb
        mkdir -p deb_package/DEBIAN
        mkdir -p deb_package/usr/local/bin
        mkdir -p deb_package/usr/share/applications
        mkdir -p deb_package/usr/share/icons/hicolor/256x256/apps
        mkdir -p deb_package/opt/modificador-pdf
        
        # Copiar la aplicación compilada
        cp -r dist/ModificadorPDF/* deb_package/opt/modificador-pdf/
        
        # Crear script de ejecución
        cat > deb_package/usr/local/bin/modificador-pdf << 'EOF'
        #!/bin/bash
        cd /opt/modificador-pdf
        ./ModificadorPDF "$@"
        EOF
        chmod +x deb_package/usr/local/bin/modificador-pdf
        
        # Crear archivo .desktop
        cat > deb_package/usr/share/applications/modificador-pdf.desktop << 'EOF'
        [Desktop Entry]
        Name=Modificador de PDF
        Comment=Editor de PDF profesional
        Exec=/opt/modificador-pdf/ModificadorPDF
        Icon=modificador-pdf
        Terminal=false
        Type=Application
        Categories=Office;Utility;
        StartupNotify=true
        EOF
        
        # Copiar icono
        if [ -f installer/app_icon.png ]; then
          cp installer/app_icon.png deb_package/usr/share/icons/hicolor/256x256/apps/modificador-pdf.png
        fi
        
        # Obtener tamaño instalado
        INSTALLED_SIZE=$(du -sk deb_package | cut -f1)
        
        # Crear archivo de control
        cat > deb_package/DEBIAN/control << EOF
        Package: modificador-pdf
        Version: 1.1.0
        Section: utils
        Priority: optional
        Architecture: amd64
        Installed-Size: ${INSTALLED_SIZE}
        Maintainer: Oriol Alonso Esplugas <alonsoesplugas@gmail.com>
        Description: PDF Editor Pro - Editor de PDF profesional
         Aplicación para editar, modificar y manipular archivos PDF.
         Permite añadir texto, imágenes, firmas y más.
        EOF
        
        # Crear script postinst
        cat > deb_package/DEBIAN/postinst << 'EOF'
        #!/bin/bash
        chmod +x /opt/modificador-pdf/ModificadorPDF
        update-desktop-database 2>/dev/null || true
        gtk-update-icon-cache /usr/share/icons/hicolor 2>/dev/null || true
        EOF
        chmod 755 deb_package/DEBIAN/postinst
        
        # Construir el paquete .deb
        dpkg-deb --build deb_package dist/ModificadorPDF_Linux_amd64.deb
    
    - name: Crear AppImage
      run: |
        # Descargar appimagetool
        wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
        chmod +x appimagetool
        
        # Crear estructura AppDir
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Copiar aplicación
        cp -r dist/ModificadorPDF/* AppDir/usr/bin/
        
        # Crear desktop file
        cat > AppDir/modificador-pdf.desktop << 'EOF'
        [Desktop Entry]
        Name=Modificador de PDF
        Comment=Editor de PDF profesional
        Exec=ModificadorPDF
        Icon=modificador-pdf
        Terminal=false
        Type=Application
        Categories=Office;Utility;
        EOF
        cp AppDir/modificador-pdf.desktop AppDir/usr/share/applications/
        
        # Copiar icono
        if [ -f installer/app_icon.png ]; then
          cp installer/app_icon.png AppDir/modificador-pdf.png
          cp installer/app_icon.png AppDir/usr/share/icons/hicolor/256x256/apps/modificador-pdf.png
        else
          # Crear icono placeholder si no existe
          convert -size 256x256 xc:blue AppDir/modificador-pdf.png 2>/dev/null || touch AppDir/modificador-pdf.png
        fi
        
        # Crear AppRun
        cat > AppDir/AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin:${PATH}"
        export LD_LIBRARY_PATH="${HERE}/usr/bin:${LD_LIBRARY_PATH}"
        exec "${HERE}/usr/bin/ModificadorPDF" "$@"
        EOF
        chmod +x AppDir/AppRun
        
        # Crear AppImage
        ARCH=x86_64 ./appimagetool AppDir dist/ModificadorPDF_Linux_x86_64.AppImage || echo "AppImage creation skipped"
    
    - name: Subir artefactos Linux
      uses: actions/upload-artifact@v4
      with:
        name: Linux-Installers
        path: |
          dist/ModificadorPDF_Linux_Portable.tar.gz
          dist/ModificadorPDF_Linux_amd64.deb
          dist/ModificadorPDF_Linux_x86_64.AppImage
        retention-days: 30

  # ==================== CREAR RELEASE ====================
  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Descargar artefactos Windows
      uses: actions/download-artifact@v4
      with:
        name: Windows-Installers
        path: ./release
      continue-on-error: true
    
    - name: Descargar artefactos macOS
      uses: actions/download-artifact@v4
      with:
        name: macOS-Installer
        path: ./release
      continue-on-error: true
    
    - name: Descargar artefactos Linux
      uses: actions/download-artifact@v4
      with:
        name: Linux-Installers
        path: ./release
      continue-on-error: true

    - name: Listar archivos descargados
      run: |
        echo "Contenido de ./release:"
        ls -la ./release/ || echo "Carpeta vacia"
        find ./release -type f || echo "No hay archivos"
    
    - name: Crear Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        draft: false
        prerelease: false
        generate_release_notes: true
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
